"use client";

import React, { useEffect, useMemo, useState } from "react";
import Image from "next/image";
import {
	Menubar,
	MenubarMenu,
	MenubarTrigger,
	MenubarContent,
	MenubarLabel,
	MenubarSeparator,
	MenubarRadioGroup,
	MenubarRadioItem,
	MenubarItem,
	MenubarSub,
	MenubarSubTrigger,
	MenubarSubContent,
} from "@/components/ui/menubar";
import {
	ArrowDownAZ,
	ArrowUpAZ,
	Image as ImageIcon,
	Menu,
	Palette,
	RotateCcw,
	Shuffle,
	Timer,
	Volume2,
} from "lucide-react";

const timerOptions = Array.from({ length: 20 }, (_, index) => index + 1);

const Navbar = ({
	onNamesOrderChange,
	onTimerChange,
	onBackgroundChange,
	currentNameOrder = "shuffle",
	currentTimer = 3,
}) => {
	const [orderValue, setOrderValue] = useState(currentNameOrder);
	const [timerValue, setTimerValue] = useState(String(currentTimer));
	const [imageFiles, setImageFiles] = useState([]);
	const [loadingImages, setLoadingImages] = useState(true);

	useEffect(() => {
		setOrderValue(currentNameOrder);
	}, [currentNameOrder]);

	useEffect(() => {
		setTimerValue(String(currentTimer));
	}, [currentTimer]);

	useEffect(() => {
		// Fetch images dynamically from API
		setLoadingImages(true);
		fetch("/api/images")
			.then((res) => res.json())
			.then((data) => {
				setImageFiles(data.images || []);
				setLoadingImages(false);
			})
			.catch((err) => {
				console.error("Error fetching images:", err);
				setLoadingImages(false);
			});
	}, []);

	const handleOrderChange = (value) => {
		setOrderValue(value);
		onNamesOrderChange?.(value);
	};

	const handleTimerChange = (value) => {
		setTimerValue(value);
		onTimerChange?.(Number(value));
	};

	const handleColorChange = (event) => {
		const value = event.target.value;
		onBackgroundChange?.({ type: "color", value });
	};

	const handleResetBackground = () => {
		onBackgroundChange?.({ type: "reset" });
	};

	const handleImageClick = (imagePath) => {
		onBackgroundChange?.({ type: "image", value: imagePath });
	};

	const menubarItems = useMemo(
		() => (
			<Menubar className="bg-transparent border-0 shadow-none">
				<MenubarMenu>
					<MenubarTrigger>
t			<MenubarTrigger className="cursor-pointer hover:text-orange-700 transition-colors">
						<Shuffle className="mr-2 h-4 w-4" />
						Names Orders
					</MenubarTrigger>
					<MenubarContent className="min-w-[230px]">
						<MenubarLabel>Sort the wheel entries</MenubarLabel>
						<MenubarSeparator />
						<MenubarRadioGroup
							value={orderValue}
							onValueChange={handleOrderChange}
						>
							<MenubarRadioItem value="shuffle">
								<Shuffle className="h-4 w-4" /> Shuffle
							</MenubarRadioItem>
							<MenubarRadioItem value="ascending">
								<ArrowUpAZ className="h-4 w-4" /> Ascending
							</MenubarRadioItem>
							<MenubarRadioItem value="descending">
								<ArrowDownAZ className="h-4 w-4" /> Descending
							</MenubarRadioItem>
						</MenubarRadioGroup>
					</MenubarContent>
				</MenubarMenu>

				<MenubarMenu>
					<MenubarTrigger>
						<Timer className="mr-2 h-4 w-4" /> Timers
					</MenubarTrigger>
					<MenubarContent className="max-h-[320px] min-w-[210px] overflow-y-auto">
						<MenubarLabel>Spin duration</MenubarLabel>
						<MenubarSeparator />
						<MenubarRadioGroup
							value={timerValue}
							onValueChange={handleTimerChange}
						>
							{timerOptions.map((seconds) => (
								<MenubarRadioItem key={seconds} value={String(seconds)}>
									{seconds} {seconds === 1 ? "Second" : "Seconds"}
								</MenubarRadioItem>
							))}
						</MenubarRadioGroup>
					</MenubarContent>
				</MenubarMenu>

				<MenubarMenu>
					<MenubarTrigger>
						<Volume2 className="mr-2 h-4 w-4" /> Sounds
					</MenubarTrigger>
					<MenubarContent className="min-w-[200px]">
						<MenubarLabel>Sound configuration</MenubarLabel>
						<MenubarSeparator />
						<MenubarItem disabled>Sound presets coming soon</MenubarItem>
					</MenubarContent>
				</MenubarMenu>

				<MenubarMenu>
					<MenubarTrigger>
						<Palette className="mr-2 h-4 w-4" /> Backgrounds
					</MenubarTrigger>
					<MenubarContent className="min-w-[230px]">
						<MenubarLabel>Customize the stage</MenubarLabel>
						<MenubarSeparator />
						<MenubarSub>
							<MenubarSubTrigger>
								<Palette className="h-4 w-4" /> Colors
							</MenubarSubTrigger>
							<MenubarSubContent>
								<div className="space-y-2 p-2 text-sm">
									<p className="text-muted-foreground text-xs uppercase tracking-wide">
										Pick a hue
									</p>
									<input
										type="color"
										className="h-10 w-full cursor-pointer rounded border border-muted"
										onChange={handleColorChange}
										aria-label="Select background color"
									/>
								</div>
							</MenubarSubContent>
						</MenubarSub>
						<MenubarSub>
							<MenubarSubTrigger>
								<ImageIcon className="h-4 w-4" /> Images
							</MenubarSubTrigger>
							<MenubarSubContent className="w-[80%] md:w-[700px] max-h-[400px] overflow-y-auto">
								<div className="p-3">
									<p className="text-muted-foreground text-xs uppercase tracking-wide mb-3">
										Choose background
									</p>
									{loadingImages ? (
										<div className="flex items-center justify-center py-8">
											<div className="animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div>
										</div>
									) : imageFiles.length === 0 ? (
										<p className="text-sm text-muted-foreground py-4 text-center">
											No images found in /public/images
										</p>
									) : (
										<div className="flex flex-wrap gap-2">
											{imageFiles.map((img) => (
												<div
													key={img}
													className="w-[200px] h-[200px] cursor-pointer rounded overflow-hidden border-2 border-muted hover:border-primary transition-colors relative bg-muted"
													onClick={() => handleImageClick(`/images/${img}`)}
												>
													<Image
														src={`/images/${img}`}
														alt={`Background ${img}`}
														fill
														sizes="200px"
														className="object-cover"
														loading="lazy"
														quality={75}
													/>
												</div>
											))}
										</div>
									)}
								</div>
							</MenubarSubContent>
						</MenubarSub>
						<MenubarSeparator />
						<MenubarItem onClick={handleResetBackground}>
							<RotateCcw className="h-4 w-4" /> Reset Background
						</MenubarItem>
					</MenubarContent>
				</MenubarMenu>
			</Menubar>
		),
		[orderValue, timerValue, imageFiles, loadingImages]
	);

	return (
		<div className="bg-orange-200/90 shadow-lg">
			<div className="container mx-auto flex h-[64px] items-center justify-between px-4">
				<section
					id="banner"
					className="font-bold text-lg tracking-wide text-orange-950"
				>
					SPIN THE NAMES
				</section>
				<section id="menu" className="hidden md:block">
					{menubarItems}
				</section>
				<section id="menu-mobile" className="md:hidden">
					<button
						type="button"
						className="inline-flex items-center gap-2 rounded-md border border-orange-300/70 bg-white/90 px-3 py-2 text-sm font-medium text-orange-900 shadow-sm"
						aria-label="Menu available on larger screens"
						disabled
					>
						<Menu className="h-4 w-4" />
						Menu (desktop only)
					</button>
				</section>
			</div>
		</div>
	);
};

export default Navbar;
